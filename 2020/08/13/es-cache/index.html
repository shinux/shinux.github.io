<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><title>Elasticsearch query cache</title><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/heti.min.css"><link rel="stylesheet" href="/css/hexo-theme-adoubi.css"><link rel="icon" href="/images/favicon.ico"></head><body><div class="header"><a class="github-link" href="https://github.com/shinux"><img class="github-image" src="/images/Aquicon-Github-small.png"></a><a class="email-link" href="mailto:askb@me.com"><img class="email-image" src="/images/email-small.png"></a><a class="subscribe-link" href="/atom.xml"><img class="subscribe-image" src="/images/subscribe-small.png"></a></div><div class="content"><div class="post-item"></div><h2 class="post-title-wrapper"><p class="post-title">Elasticsearch query cache</p></h2><div class="post-date"><time datetime="2020-08-13T07:46:16.000Z">2020-08-13</time></div><div class="post-content"><h3 id="查看缓存占用的内存数量"><a href="#查看缓存占用的内存数量" class="headerlink" title="查看缓存占用的内存数量"></a>查看缓存占用的内存数量</h3><p>基于一个 8 节点集群，查询 QPS 大概 30 左右。通过 node 信息查看请求缓存</p>
<p><code>curl localhost:9200/_nodes/stats/indices/request_cache?pretty</code></p>
<p>执行结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_nodes&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 8,</span><br><span class="line">    &quot;successful&quot; : 8,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;moka-es&quot;,</span><br><span class="line">  &quot;nodes&quot; : &#123;</span><br><span class="line">    &quot;4FbqP65LTf-uwF1sGZAnQQ&quot; : &#123;</span><br><span class="line">      &quot;timestamp&quot; : 1597291580728,</span><br><span class="line">      &quot;name&quot; : &quot;es-node-3&quot;,</span><br><span class="line">      &quot;transport_address&quot; : &quot;172.17.240.18:9300&quot;,</span><br><span class="line">      &quot;host&quot; : &quot;172.17.240.18&quot;,</span><br><span class="line">      &quot;ip&quot; : &quot;172.17.240.18:9300&quot;,</span><br><span class="line">      &quot;roles&quot; : [</span><br><span class="line">        &quot;master&quot;,</span><br><span class="line">        &quot;data&quot;,</span><br><span class="line">        &quot;ingest&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;attributes&quot; : &#123;</span><br><span class="line">        &quot;ml.machine_memory&quot; : &quot;33738051584&quot;,</span><br><span class="line">        &quot;ml.max_open_jobs&quot; : &quot;20&quot;,</span><br><span class="line">        &quot;xpack.installed&quot; : &quot;true&quot;,</span><br><span class="line">        &quot;ml.enabled&quot; : &quot;true&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;indices&quot; : &#123;</span><br><span class="line">        &quot;request_cache&quot; : &#123;</span><br><span class="line">          &quot;memory_size_in_bytes&quot; : 53328,</span><br><span class="line">          &quot;evictions&quot; : 0,</span><br><span class="line">          &quot;hit_count&quot; : 1395,</span><br><span class="line">          &quot;miss_count&quot; : 10267</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;q0_ZkHoASzqRsGrCVUlQPA&quot; : &#123;</span><br><span class="line">      &quot;timestamp&quot; : 1597291580729,</span><br><span class="line">      &quot;name&quot; : &quot;es-node-8&quot;,</span><br><span class="line">      &quot;transport_address&quot; : &quot;172.17.47.73:9300&quot;,</span><br><span class="line">      &quot;host&quot; : &quot;172.17.47.73&quot;,</span><br><span class="line">      &quot;ip&quot; : &quot;172.17.47.73:9300&quot;,</span><br><span class="line">      &quot;roles&quot; : [</span><br><span class="line">        &quot;master&quot;,</span><br><span class="line">        &quot;data&quot;,</span><br><span class="line">        &quot;ingest&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;attributes&quot; : &#123;</span><br><span class="line">        &quot;ml.machine_memory&quot; : &quot;32300605440&quot;,</span><br><span class="line">        &quot;ml.max_open_jobs&quot; : &quot;20&quot;,</span><br><span class="line">        &quot;xpack.installed&quot; : &quot;true&quot;,</span><br><span class="line">        &quot;ml.enabled&quot; : &quot;true&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;indices&quot; : &#123;</span><br><span class="line">        &quot;request_cache&quot; : &#123;</span><br><span class="line">          &quot;memory_size_in_bytes&quot; : 16287,</span><br><span class="line">          &quot;evictions&quot; : 0,</span><br><span class="line">          &quot;hit_count&quot; : 23,</span><br><span class="line">          &quot;miss_count&quot; : 74</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>结果比较奇怪，相较于每个节点 32GB 的内存，几百 kb 的换存量几乎相当于没有缓存任何请求结果。</p>
<p>而随便找一台测试用的单机 es ，缓存量反而比上面集群的缓存总和还要多:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_nodes&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;nodes&quot; : &#123;</span><br><span class="line">    &quot;ccC4H-1mR4apSB5pgR6yXw&quot; : &#123;</span><br><span class="line">      &quot;timestamp&quot; : 1597292348183,</span><br><span class="line">      &quot;name&quot; : &quot;ccC4H-1&quot;,</span><br><span class="line">      &quot;transport_address&quot; : &quot;172.17.46.126:9300&quot;,</span><br><span class="line">      &quot;host&quot; : &quot;172.17.46.126&quot;,</span><br><span class="line">      &quot;ip&quot; : &quot;172.17.46.126:9300&quot;,</span><br><span class="line">      &quot;roles&quot; : [</span><br><span class="line">        &quot;master&quot;,</span><br><span class="line">        &quot;data&quot;,</span><br><span class="line">        &quot;ingest&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;attributes&quot; : &#123;</span><br><span class="line">        &quot;ml.machine_memory&quot; : &quot;33191542784&quot;,</span><br><span class="line">        &quot;xpack.installed&quot; : &quot;true&quot;,</span><br><span class="line">        &quot;ml.max_open_jobs&quot; : &quot;20&quot;,</span><br><span class="line">        &quot;ml.enabled&quot; : &quot;true&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;indices&quot; : &#123;</span><br><span class="line">        &quot;request_cache&quot; : &#123;</span><br><span class="line">          &quot;memory_size_in_bytes&quot; : 2653163,</span><br><span class="line">          &quot;evictions&quot; : 0,</span><br><span class="line">          &quot;hit_count&quot; : 1353,</span><br><span class="line">          &quot;miss_count&quot; : 2439</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="什么样的-query-会被-cache"><a href="#什么样的-query-会被-cache" class="headerlink" title="什么样的 query 会被 cache ?"></a>什么样的 query 会被 cache ?</h3><blockquote>
<p>It is not possible to look at the contents being cached.</p>
</blockquote>
<p>而且除非自己 log，es 也没办法看到 query history（？）我们只能通过 node API，index 级别的配置和 query type 去判断缓存的使用情况。</p>
<p>这里不同的 doc 、书、网上的文章说的有点出入。在我的理解里，只有两种 query cache， node query cache 和 shards query cache。</p>
<h4 id="node-query-cache"><a href="#node-query-cache" class="headerlink" title="node query cache"></a>node query cache</h4><p>node query cache 只保留 filter 类型的 query result。</p>
<p>es 的 node query cache 默认是开启的，基于 LRU（least recently use），当缓存达到上限，一条新缓存出现的同时会驱逐（evict）最近最少使用的那一条。</p>
<p>从 query 类型来看，除了 filter 类型的 query ，其他任何类型的 query 结果都不会被缓存。从数量和大小来看，默认会保存最多一万条或最多 10% 的 heap size 的 query。因 cache 基于 segment, 当 segment（一个真实的倒排索引文件）的 doc 数量小于一万条或小于当前 shards 的 3% 或者总的请求数量过小时，都不会触发 cache。</p>
<h4 id="shard-request-cache"><a href="#shard-request-cache" class="headerlink" title="shard request cache"></a>shard request cache</h4><p>shard request cache 就是把在各个 shard 上执行的 query 本地结果缓存下来。 一样也是 LRU 机制。他会缓存频繁请求的结果或者通过对每一个 query 手动添加 <code>request_cache=true</code> 来决定一个请求是否触发缓存。</p>
<p>注意，这里默认只会缓存 size = 0 的 query 结果，也就是一些可以不在意 hits 的 query，比如 aggregation，suggestion。这意味着如果不手动标识，日常针对普通 field 的搜索想要召回具体命中 doc 的 query 全部不会被缓存。这也解释了为什么上述的集群几乎没有 request cache。</p>
<h3 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h3><p>其他的缓存方案大同小异，就是在得到结果后，配合 query 做一个 k-v 形式的缓存，区别只是缓存选型、数据更新、缓存过期时间上的处理。例如这个 <a href="https://medium.com/trackit/how-to-add-a-redis-caching-layer-to-your-elasticsearch-queries-ca56e5e84d9b" target="_blank" rel="noopener">利用 Redis 做缓存</a></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://doc.yonyoucloud.com/doc/mastering-elasticsearch/chapter-5/54_README.html" target="_blank" rel="noopener">Mastering Elasticsearch</a><br><a href="https://sematext.com/blog/elasticsearch-cache-usage/" target="_blank" rel="noopener">ElasticSearch Cache Usage</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-cache.html" target="_blank" rel="noopener">Query Cache</a></p>
</div></div><div class="footer"><div class="footer-copyright">Theme By <a href="https://github.com/shinux/hexo-theme-adoubi">Adoubi</a> , Powered By Hexo.</div></div></body></html>